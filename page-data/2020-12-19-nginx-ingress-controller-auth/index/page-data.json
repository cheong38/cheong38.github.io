{"componentChunkName":"component---src-templates-post-tsx","path":"/2020-12-19-nginx-ingress-controller-auth/index/","result":{"data":{"logo":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAABIElEQVQoz52Su0oDQRSGZ8bWVgTBUlGxsbRMYQw2boiNhYKgkEewFKx8DFuLFKbMK9jbiIEU9rnMZSPs+p1ks+7GbeKBj//M7M4/Z86MUkuRpqnyPtY+xMa5YLwX4r+EuQ5HdrZuYn1usJEkSYSewZr6R4zGtlRRHZqYPkJL5ti5BpF1oeZ8uCK/pdIIbaMX6KXkfDvHbH25wns4xmwPnmQuhPiOIw1Z/Iy+MO5CD15Fmeti2CF/e/8YGFkznrjc8AYeoLGokN5twglswSHsww6cYta2zh9Q0TYbHpXMJDDRmF2juzL+7H+t1L+SWVahLpibrIcqu0VdZDr91vNXEAz90xx59j/z0qbfZyKmC+NsXHmLosW8MqgqN6gyWzV+AM1IPLU6r0ZQAAAAAElFTkSuQmCC","width":400,"height":174,"src":"/static/901980ec635ef9ce37ac8ad1c445a1bc/497c6/woojin-logo.png","srcSet":"/static/901980ec635ef9ce37ac8ad1c445a1bc/497c6/woojin-logo.png 1x"}}},"markdownRemark":{"html":"<p>nginx ingress controller 에 대한 설명 및 설정은 <a href=\"/2020-12-17-nginx-ingress-controller/index/\">지난 포스팅</a> 을 참고하자.</p>\n<h1>개요</h1>\n<p>서비스를 개발하다보면 회원가입, 로그인 그리고 토큰 관리 등 인증 로직을 필요로 하게 된다.</p>\n<p>그리고 이는 시스템 대부분에 걸쳐 활용된다.</p>\n<p>모놀로식 서비스에서는 인증 로직을 하나의 모듈로 구현하고, 이를 다른 모듈에서 가져다 사용하는 방법으로 인증 로직을 공유할 수 있다.</p>\n<p>마이크로서비스에서는 서브 도메인마다 서비스를 따로 배포하다보니, 모놀로식 서비스에서와는 다른 방식이 필요하다.</p>\n<p>일반적으로 아래와 같은 2가지 방법을 생각해볼 수 있다.</p>\n<ol>\n<li>인증을 필요로 하는 부분은 인증 서비스에 위임하여 처리한다.</li>\n<li>인증 로직을 구현한 모듈을 라이브러리화 하여 다른 서비스 배포 시 같이 빌드하여 배포한다.</li>\n</ol>\n<p>본 포스팅에서는 nginx ingress controller 를 활용하여 <strong>1번의 방법</strong>에 대해 알아보려고 한다.</p>\n<h1>간단한 구조</h1>\n<p>인증 로직을 인증 서비스로 위임했으니 다른 서비스에서 인증 로직을 필요로 하게 되는 경우, 다른 서비스는 인증 서비스를 호출해야 할 것이다.</p>\n<p>예를 들어 User ID 와 Role 정보를 담고 있는 JWT 를 인증 토큰으로 사용하는 경우, 다른 서비스는 요청이 들어온 경우 JWT 를 인증 서비스로\n전달하여 JWT 를 검증하고 User ID 와 Role 을 받아오도록 해야 할 것이다.</p>\n<p>이를 도식화하면 아래와 같이 그려질 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 867px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/35e9bf8e7496eb6f3f3d21359543b48f/0f9e1/simple_auth.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAA10lEQVQoz6WRyQqEQBBD+/8/TPAnVPAgenDftx5eQcRhnLlMQajqSncS1C3L4ud5/grx9HVdrQt3XnD+oc7zNGim9n2/RO/8cRxvbx0XhmHwZVn6oiisT9Pkx3G0Gde+723O89zQtq3tq6q6EsrE8bCuaxPVjEmapj4IAttjoCRKmmWZD8PQ3mzbdvEmiCMpSIggArhzpndd98YrPWmbprkSmiDKHHCGwI1ipkiob8WOe0/fXN3psoTVSRNFkaW77zUDxDULj3/5n3JJkliSOI4/APe0/4UXVly5b31cJvAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Simple Auth\"\n        title=\"Simple Auth\"\n        src=\"/static/35e9bf8e7496eb6f3f3d21359543b48f/0f9e1/simple_auth.png\"\n        srcset=\"/static/35e9bf8e7496eb6f3f3d21359543b48f/0eb09/simple_auth.png 500w,\n/static/35e9bf8e7496eb6f3f3d21359543b48f/0f9e1/simple_auth.png 867w\"\n        sizes=\"(max-width: 867px) 100vw, 867px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>알기 쉽고 특별히 어려운 과정도 아니다.</p>\n<p>그러나 여기서 발생하는 문제는 다른 서비스들이 늘어나게 될 때 생긴다.</p>\n<p>아래 그림을 보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 881px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/53b6c57f2830f7ff1abdf54586f4b56e/6fa0c/multi_service_simple_auth.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 79.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABh0lEQVQ4y42T3YrCMBCFff+nkxVU8EIUvFBQbLVWbdLZfNNMTLNFdiAm5kzOnPnprK5reb1e8nw+JxfYN9zW+/2WqqpkhvM3c86p838M4hk/WN/30nXdSBVE1+tVLpeLnnMsV05Q7PF4fAgtgvdeydmx8/ksx+NRz4YZzk4gy2CSEKcy5fIuN7IywrZthxra5f1+TwVGAXvTNOqIn6k2teBgKIMDXyVEBX+Wy6XcbrcUgPv9fi+73S4RWspg+IFvt1txAUNQUng4HGSxWMjpdBK7g3y1Wslms9HmlDVkTNbrtS7GLykEVGdGJKRgdesC1oOhmHNWS8VDFoa7cP7TFADffWau904fEEgimSkc8AHzEdem5HOohNkQE9Xrg6AgYKUR0CdCXxCikEYwi8xWANtQE+pCsduQDgEkKlQBbsjA+ymFljJ14YsJJDj/hEbN5/Oh8+GBBkV5XFbDyZRzo0lgqGuiUtK2mqWlde8+g50T5kuy4k8FHNUy7pMKy330sAg6EhAJfwGl1uhVxnObqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Mutiple Services Simple Auth\"\n        title=\"Mutiple Services Simple Auth\"\n        src=\"/static/53b6c57f2830f7ff1abdf54586f4b56e/6fa0c/multi_service_simple_auth.png\"\n        srcset=\"/static/53b6c57f2830f7ff1abdf54586f4b56e/0eb09/multi_service_simple_auth.png 500w,\n/static/53b6c57f2830f7ff1abdf54586f4b56e/6fa0c/multi_service_simple_auth.png 881w\"\n        sizes=\"(max-width: 881px) 100vw, 881px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>서비스가 많이 늘어나고 각 서비스들이 인증 로직을 필요로 한다면, 인증을 필요로 하는 모든 서비스가 각각 Auth Service 를 호출해야 할 것이다.</p>\n<p>그 서비스를 또 각기 다른 팀에서 개발한다면, 팀마다 각기 다른 방식의 인증 호출 로직 코드가 들어갈 것이다.</p>\n<p>이는 장기적으로 볼 때 전체 서비스에 대한 유지보수성을 떨어뜨릴 수 있다.</p>\n<p>이를 해결하기 위해 Nginx Ingress Controller 의 auth 기능을 이용할 수 있다.</p>\n<h1>더 나은 구조</h1>\n<p>Kubernetes 에서 nginx ingress controller 를 이용하면 서비스로 요청을 보내기 전에 Auth Service 에서 인증을 거친 후,\n인증 실패 시, 다른 서비스로 요청을 보내지 않고 바로 User 에 에러 응답을 내려주고, 인증 성공 시 인증 데이터를 주입(inject) 하여,\n다른 서비스로 요청을 보낼 수 있다.</p>\n<p>이 구조를 그림으로 나타내면 아래와 같다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1011px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9885b61e8464142b4630b4a10b956c70/0d97d/better_arch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA3ElEQVQoz3WRyYrFUAhE8/9flQ/ILlllHQgZyDxP1RzBB3ndLYji1bLKG0zTpOM4fvm+79q2TU3TqCgK0TfPs8VxHC1f19V6ied5CgsoYPd9W5H4PI/cruuyYcBZ0ratkiSxnDfv+QDywMAwDMam73vbmKapqqqSvwNUlqXyPFdd11qW5QMI2IshEgDsus4c0DAMFcexSQSMSN0Hv1W8GFIAmK2wc3nknICchc4ecGp+rhdDT/4zAAHA6UVyFEUGzCkgAQGXH/gvs/EvR26WZXY/zgFTPxFgrsSJ/QDW9x98th8F7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Better Architecture\"\n        title=\"Better Architecture\"\n        src=\"/static/9885b61e8464142b4630b4a10b956c70/0d97d/better_arch.png\"\n        srcset=\"/static/9885b61e8464142b4630b4a10b956c70/0eb09/better_arch.png 500w,\n/static/9885b61e8464142b4630b4a10b956c70/1263b/better_arch.png 1000w,\n/static/9885b61e8464142b4630b4a10b956c70/0d97d/better_arch.png 1011w\"\n        sizes=\"(max-width: 1011px) 100vw, 1011px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h2>실제 구현</h2>\n<p>구현에 앞서 Nginx Ingress Controller 가 설정되어 있어야 한다. Minkube 에 Nginx Ingress Controller 를 설정하는 법은\n<a href=\"/2020-12-17-nginx-ingress-controller/index/\">이전 포스팅</a>을 참고 바란다.</p>\n<h3>Ingress</h3>\n<p>Ingress 에 다음과 같은 annotation 을 추가해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ingress.yaml</span>\n\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># Some metadata</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/auth-url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//auth.default.svc.cluster.local/auth/authz\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/auth-method</span><span class=\"token punctuation\">:</span> POST\n    <span class=\"token key atrule\">nginx.ingress.kubernetes.io/auth-response-headers</span><span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>role<span class=\"token punctuation\">,</span>x<span class=\"token punctuation\">-</span>auth<span class=\"token punctuation\">-</span>id\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Define rules</span></code></pre></div>\n<p><code class=\"language-text\">default</code> namespace 에 auth 라는 이름으로 서비스가 정의되어 있고, 해당 서비스는 <code class=\"language-text\">POST /authz</code> 경로로 요청을 받는다.\n이 경로에서 JWT 를 검증하고 올바르지 않으면 에러를, 올바르면 성공을 응답할 것이다.</p>\n<p>추가로 <code class=\"language-text\">x-auth-role</code>, <code class=\"language-text\">x-auth-id</code> 를 auth 응답 헤더르 지정하여 인증된 사용자의 역할과 ID 를 다른 서비스에서 해당 이름의\n헤더로 받아볼 수 있게 하였다. 이 필드는 필요에 따라 추가, 수정하거나 삭제할 수 있다.</p>\n<p>annotation 에 대한 자세한 설명과 추가적인 필드는 <a href=\"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication\">공식 문서</a>를 참조한다.</p>\n<h3>Auth Service</h3>\n<p>Auth 서비스를 전부를 이 포스팅에서 구현하긴 분량이 너무 많을 듯 하고 필요한 부분인 authz 경로의 로직을 살펴보자.</p>\n<p>먼저 JWT 의 구조를 가정해보자. JWT 의 payload 는 다음과 같이 구성되어 있다고 가정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"role\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">id</code> 는 인증된 사용자의 ID 를 의미하고, <code class=\"language-text\">role</code> 은 인증된 사용자의 역할을 의미한다. 서비스에 따라 역할을 복수가 될 수도 있을 것이고,\n다른 데이터가 필요하다면 추가할 수도 있을 것이다.</p>\n<p>다음으로 authz 의 구현을 단순화하여 살펴보자.\nnodejs 와 express 로 구현하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/authz'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> authorization <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'authorization'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// authorization = `Bearer &lt;jwt-token>` 과 같이 전달될텐데,</span>\n  <span class=\"token comment\">// extractJwt 함수에서는 &lt;jwt-token> 부분을 추출한다.</span>\n  <span class=\"token keyword\">const</span> jwt <span class=\"token operator\">=</span> <span class=\"token function\">extractJwt</span><span class=\"token punctuation\">(</span>authorization<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 일반적으로 라이브러리를 이용하여 verify 가 구현될 것이다.</span>\n    <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>jwt<span class=\"token punctuation\">)</span>\n    res\n      <span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x-auth-role'</span><span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">.</span>role<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x-auth-id'</span><span class=\"token punctuation\">,</span> payload<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">statue</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 여기서는 토큰이 인증되지 못한 경우 401 (Unauthorized) 를 응답하도록 하였다.</span>\n    res\n      <span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">401</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Auth Service 를 위한 ingress 정의</h3>\n<p>auth 서비스는 다른 ingress 로 정의해주어야 한다. 위의 <code class=\"language-text\">ingress.yaml</code> 에 같이 정의하게 되면, auth 도 인증 로직을 거치게 되어,\nauthz 를 호출할 때도 <code class=\"language-text\">authorization</code> 헤더를 요청하게 되는 문제가 발생할 것이다.</p>\n<p>아래와 같이 새로운 ingress 를 정의하여 kubernetes cluster 에 추가해주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># ingress-no-auth.yaml</span>\n\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> networking.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Ingress\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> main<span class=\"token punctuation\">-</span>ingress<span class=\"token punctuation\">-</span>no<span class=\"token punctuation\">-</span>auth\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> default\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">http</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">paths</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /auth\n            <span class=\"token key atrule\">pathType</span><span class=\"token punctuation\">:</span> Prefix\n            <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">serviceName</span><span class=\"token punctuation\">:</span> auth\n              <span class=\"token key atrule\">servicePort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<h3>다른 서비스에서 인증 데이터 사용하기</h3>\n<p><code class=\"language-text\">ingress.yaml</code> 에 다른 서비스로의 경로를 지정해주면 해당 서비스를 호출하기 전에 auth 의 <code class=\"language-text\">authz</code> 를 수행하여 인증 데이터를 주입받는다.</p>\n<p>nodejs 와 express 로 간단히 코드를 살펴보면 아래와 같을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/something'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> role <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-auth-role'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> userId <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'x-auth-id'</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// Do something with `role` and `userId`</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h1>마무리</h1>\n<p>Nginx Ingress Controller 를 이용하여 마이크로서비스 인증 로직을 하나의 서비스에서 처리하고, 다른 서비스에서는 인증 로직에 대해\n신경을 쓰지 않을 수 있도록 하는 구조에 대해 알아봤다. 이를 이용하면, <strong>서비스마다 관심사</strong>를 분리하는데 보다 도움이 될 수 있을 것이다.</p>\n<p>실제 프로젝트를 진행하다보면, 특정 경로로 들어오는 경우에는 인증을 거치지 않아야 하는 것이 필요할 수 있다.\n이 때는 특정 경로에 대해서는 인증 로직을 수행하지 않도록 예외처리가 필요하다.</p>\n<p>이 부분에 대해서는 다음 포스팅에서 알아보도록 하자.</p>","htmlAst":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"nginx ingress controller 에 대한 설명 및 설정은 "},{"type":"element","tagName":"a","properties":{"href":"/2020-12-17-nginx-ingress-controller/index/"},"children":[{"type":"text","value":"지난 포스팅"}]},{"type":"text","value":" 을 참고하자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"개요"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"서비스를 개발하다보면 회원가입, 로그인 그리고 토큰 관리 등 인증 로직을 필요로 하게 된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그리고 이는 시스템 대부분에 걸쳐 활용된다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"모놀로식 서비스에서는 인증 로직을 하나의 모듈로 구현하고, 이를 다른 모듈에서 가져다 사용하는 방법으로 인증 로직을 공유할 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"마이크로서비스에서는 서브 도메인마다 서비스를 따로 배포하다보니, 모놀로식 서비스에서와는 다른 방식이 필요하다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"일반적으로 아래와 같은 2가지 방법을 생각해볼 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"ol","properties":{},"children":[{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"인증을 필요로 하는 부분은 인증 서비스에 위임하여 처리한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"li","properties":{},"children":[{"type":"text","value":"인증 로직을 구현한 모듈을 라이브러리화 하여 다른 서비스 배포 시 같이 빌드하여 배포한다."}]},{"type":"text","value":"\n"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"본 포스팅에서는 nginx ingress controller 를 활용하여 "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"1번의 방법"}]},{"type":"text","value":"에 대해 알아보려고 한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"간단한 구조"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"인증 로직을 인증 서비스로 위임했으니 다른 서비스에서 인증 로직을 필요로 하게 되는 경우, 다른 서비스는 인증 서비스를 호출해야 할 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"예를 들어 User ID 와 Role 정보를 담고 있는 JWT 를 인증 토큰으로 사용하는 경우, 다른 서비스는 요청이 들어온 경우 JWT 를 인증 서비스로\n전달하여 JWT 를 검증하고 User ID 와 Role 을 받아오도록 해야 할 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이를 도식화하면 아래와 같이 그려질 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 867px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/35e9bf8e7496eb6f3f3d21359543b48f/0f9e1/simple_auth.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 42.8%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsSAAALEgHS3X78AAAA10lEQVQoz6WRyQqEQBBD+/8/TPAnVPAgenDftx5eQcRhnLlMQajqSncS1C3L4ud5/grx9HVdrQt3XnD+oc7zNGim9n2/RO/8cRxvbx0XhmHwZVn6oiisT9Pkx3G0Gde+723O89zQtq3tq6q6EsrE8bCuaxPVjEmapj4IAttjoCRKmmWZD8PQ3mzbdvEmiCMpSIggArhzpndd98YrPWmbprkSmiDKHHCGwI1ipkiob8WOe0/fXN3psoTVSRNFkaW77zUDxDULj3/5n3JJkliSOI4/APe0/4UXVly5b31cJvAAAAAASUVORK5CYII='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Simple Auth","title":"Simple Auth","src":"/static/35e9bf8e7496eb6f3f3d21359543b48f/0f9e1/simple_auth.png","srcSet":["/static/35e9bf8e7496eb6f3f3d21359543b48f/0eb09/simple_auth.png 500w","/static/35e9bf8e7496eb6f3f3d21359543b48f/0f9e1/simple_auth.png 867w"],"sizes":["(max-width:","867px)","100vw,","867px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"알기 쉽고 특별히 어려운 과정도 아니다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그러나 여기서 발생하는 문제는 다른 서비스들이 늘어나게 될 때 생긴다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"아래 그림을 보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 881px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/53b6c57f2830f7ff1abdf54586f4b56e/6fa0c/multi_service_simple_auth.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 79.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAABh0lEQVQ4y42T3YrCMBCFff+nkxVU8EIUvFBQbLVWbdLZfNNMTLNFdiAm5kzOnPnprK5reb1e8nw+JxfYN9zW+/2WqqpkhvM3c86p838M4hk/WN/30nXdSBVE1+tVLpeLnnMsV05Q7PF4fAgtgvdeydmx8/ksx+NRz4YZzk4gy2CSEKcy5fIuN7IywrZthxra5f1+TwVGAXvTNOqIn6k2teBgKIMDXyVEBX+Wy6XcbrcUgPv9fi+73S4RWspg+IFvt1txAUNQUng4HGSxWMjpdBK7g3y1Wslms9HmlDVkTNbrtS7GLykEVGdGJKRgdesC1oOhmHNWS8VDFoa7cP7TFADffWau904fEEgimSkc8AHzEdem5HOohNkQE9Xrg6AgYKUR0CdCXxCikEYwi8xWANtQE+pCsduQDgEkKlQBbsjA+ymFljJ14YsJJDj/hEbN5/Oh8+GBBkV5XFbDyZRzo0lgqGuiUtK2mqWlde8+g50T5kuy4k8FHNUy7pMKy330sAg6EhAJfwGl1uhVxnObqgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Mutiple Services Simple Auth","title":"Mutiple Services Simple Auth","src":"/static/53b6c57f2830f7ff1abdf54586f4b56e/6fa0c/multi_service_simple_auth.png","srcSet":["/static/53b6c57f2830f7ff1abdf54586f4b56e/0eb09/multi_service_simple_auth.png 500w","/static/53b6c57f2830f7ff1abdf54586f4b56e/6fa0c/multi_service_simple_auth.png 881w"],"sizes":["(max-width:","881px)","100vw,","881px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"서비스가 많이 늘어나고 각 서비스들이 인증 로직을 필요로 한다면, 인증을 필요로 하는 모든 서비스가 각각 Auth Service 를 호출해야 할 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"그 서비스를 또 각기 다른 팀에서 개발한다면, 팀마다 각기 다른 방식의 인증 호출 로직 코드가 들어갈 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이는 장기적으로 볼 때 전체 서비스에 대한 유지보수성을 떨어뜨릴 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이를 해결하기 위해 Nginx Ingress Controller 의 auth 기능을 이용할 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"더 나은 구조"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Kubernetes 에서 nginx ingress controller 를 이용하면 서비스로 요청을 보내기 전에 Auth Service 에서 인증을 거친 후,\n인증 실패 시, 다른 서비스로 요청을 보내지 않고 바로 User 에 에러 응답을 내려주고, 인증 성공 시 인증 데이터를 주입(inject) 하여,\n다른 서비스로 요청을 보낼 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이 구조를 그림으로 나타내면 아래와 같다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-wrapper"],"style":"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1011px; "},"children":[{"type":"text","value":"\n      "},{"type":"element","tagName":"a","properties":{"className":["gatsby-resp-image-link"],"href":"/static/9885b61e8464142b4630b4a10b956c70/0d97d/better_arch.png","style":"display: block","target":"_blank","rel":["noopener"]},"children":[{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["gatsby-resp-image-background-image"],"style":"padding-bottom: 36.6%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsSAAALEgHS3X78AAAA3ElEQVQoz3WRyYrFUAhE8/9flQ/ILlllHQgZyDxP1RzBB3ndLYji1bLKG0zTpOM4fvm+79q2TU3TqCgK0TfPs8VxHC1f19V6ied5CgsoYPd9W5H4PI/cruuyYcBZ0ratkiSxnDfv+QDywMAwDMam73vbmKapqqqSvwNUlqXyPFdd11qW5QMI2IshEgDsus4c0DAMFcexSQSMSN0Hv1W8GFIAmK2wc3nknICchc4ecGp+rhdDT/4zAAHA6UVyFEUGzCkgAQGXH/gvs/EvR26WZXY/zgFTPxFgrsSJ/QDW9x98th8F7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"},"children":[]},{"type":"text","value":"\n  "},{"type":"element","tagName":"img","properties":{"className":["gatsby-resp-image-image"],"alt":"Better Architecture","title":"Better Architecture","src":"/static/9885b61e8464142b4630b4a10b956c70/0d97d/better_arch.png","srcSet":["/static/9885b61e8464142b4630b4a10b956c70/0eb09/better_arch.png 500w","/static/9885b61e8464142b4630b4a10b956c70/1263b/better_arch.png 1000w","/static/9885b61e8464142b4630b4a10b956c70/0d97d/better_arch.png 1011w"],"sizes":["(max-width:","1011px)","100vw,","1011px"],"style":"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;","loading":"lazy"},"children":[]},{"type":"text","value":"\n  "}]},{"type":"text","value":"\n    "}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"실제 구현"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"구현에 앞서 Nginx Ingress Controller 가 설정되어 있어야 한다. Minkube 에 Nginx Ingress Controller 를 설정하는 법은\n"},{"type":"element","tagName":"a","properties":{"href":"/2020-12-17-nginx-ingress-controller/index/"},"children":[{"type":"text","value":"이전 포스팅"}]},{"type":"text","value":"을 참고 바란다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Ingress"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Ingress 에 다음과 같은 annotation 을 추가해준다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ingress.yaml"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" networking.k8s.io/v1beta1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Some metadata"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"annotations"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"nginx.ingress.kubernetes.io/auth-url"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" http"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"//auth.default.svc.cluster.local/auth/authz\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"nginx.ingress.kubernetes.io/auth-method"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" POST\n    "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"nginx.ingress.kubernetes.io/auth-response-headers"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" x"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"auth"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"role"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"x"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"auth"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"id\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"rules"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# Define rules"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"default"}]},{"type":"text","value":" namespace 에 auth 라는 이름으로 서비스가 정의되어 있고, 해당 서비스는 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"POST /authz"}]},{"type":"text","value":" 경로로 요청을 받는다.\n이 경로에서 JWT 를 검증하고 올바르지 않으면 에러를, 올바르면 성공을 응답할 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"추가로 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"x-auth-role"}]},{"type":"text","value":", "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"x-auth-id"}]},{"type":"text","value":" 를 auth 응답 헤더르 지정하여 인증된 사용자의 역할과 ID 를 다른 서비스에서 해당 이름의\n헤더로 받아볼 수 있게 하였다. 이 필드는 필요에 따라 추가, 수정하거나 삭제할 수 있다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"annotation 에 대한 자세한 설명과 추가적인 필드는 "},{"type":"element","tagName":"a","properties":{"href":"https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#external-authentication"},"children":[{"type":"text","value":"공식 문서"}]},{"type":"text","value":"를 참조한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Auth Service"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Auth 서비스를 전부를 이 포스팅에서 구현하긴 분량이 너무 많을 듯 하고 필요한 부분인 authz 경로의 로직을 살펴보자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"먼저 JWT 의 구조를 가정해보자. JWT 의 payload 는 다음과 같이 구성되어 있다고 가정한다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"json"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-json"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"id\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"string\""}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","property"]},"children":[{"type":"text","value":"\"role\""}]},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"\"string\""}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"id"}]},{"type":"text","value":" 는 인증된 사용자의 ID 를 의미하고, "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"role"}]},{"type":"text","value":" 은 인증된 사용자의 역할을 의미한다. 서비스에 따라 역할을 복수가 될 수도 있을 것이고,\n다른 데이터가 필요하다면 추가할 수도 있을 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"다음으로 authz 의 구현을 단순화하여 살펴보자.\nnodejs 와 express 로 구현하였다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"javascript"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-javascript"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"app"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"post"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'/authz'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"req"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" res"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" next"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=>"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" authorization "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" req"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"headers"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'authorization'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// authorization = `Bearer <jwt-token>` 과 같이 전달될텐데,"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// extractJwt 함수에서는 <jwt-token> 부분을 추출한다."}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" jwt "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"extractJwt"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"authorization"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"try"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// 일반적으로 라이브러리를 이용하여 verify 가 구현될 것이다."}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" payload "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"verify"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"jwt"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n    res\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'x-auth-role'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" payload"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"role"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"set"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'x-auth-id'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" payload"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"id"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"statue"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"200"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"send"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"catch"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"error"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// 여기서는 토큰이 인증되지 못한 경우 401 (Unauthorized) 를 응답하도록 하였다."}]},{"type":"text","value":"\n    res\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"status"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"401"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n      "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"send"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"text","value":"error"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"Auth Service 를 위한 ingress 정의"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"auth 서비스는 다른 ingress 로 정의해주어야 한다. 위의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ingress.yaml"}]},{"type":"text","value":" 에 같이 정의하게 되면, auth 도 인증 로직을 거치게 되어,\nauthz 를 호출할 때도 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"authorization"}]},{"type":"text","value":" 헤더를 요청하게 되는 문제가 발생할 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"아래와 같이 새로운 ingress 를 정의하여 kubernetes cluster 에 추가해주자."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"yaml"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-yaml"]},"children":[{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"# ingress-no-auth.yaml"}]},{"type":"text","value":"\n\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"apiVersion"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" networking.k8s.io/v1beta1\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"kind"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Ingress\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"metadata"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"name"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" main"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"ingress"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"no"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":"auth\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"namespace"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" default\n"},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"spec"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"rules"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n    "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"http"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n        "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"paths"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n          "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"-"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"path"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" /auth\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"pathType"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" Prefix\n            "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"backend"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":"\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"serviceName"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" auth\n              "},{"type":"element","tagName":"span","properties":{"className":["token","key","atrule"]},"children":[{"type":"text","value":"servicePort"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":":"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","number"]},"children":[{"type":"text","value":"80"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h3","properties":{},"children":[{"type":"text","value":"다른 서비스에서 인증 데이터 사용하기"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"ingress.yaml"}]},{"type":"text","value":" 에 다른 서비스로의 경로를 지정해주면 해당 서비스를 호출하기 전에 auth 의 "},{"type":"element","tagName":"code","properties":{"className":["language-text"]},"children":[{"type":"text","value":"authz"}]},{"type":"text","value":" 를 수행하여 인증 데이터를 주입받는다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"nodejs 와 express 로 간단히 코드를 살펴보면 아래와 같을 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"div","properties":{"className":["gatsby-highlight"],"dataLanguage":"javascript"},"children":[{"type":"element","tagName":"pre","properties":{"className":["language-javascript"]},"children":[{"type":"element","tagName":"code","properties":{"className":["language-javascript"]},"children":[{"type":"text","value":"app"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"element","tagName":"span","properties":{"className":["token","function"]},"children":[{"type":"text","value":"get"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'/something'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"("}]},{"type":"element","tagName":"span","properties":{"className":["token","parameter"]},"children":[{"type":"text","value":"req"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" res"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":","}]},{"type":"text","value":" next"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"=>"}]},{"type":"text","value":" "},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"{"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" role "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" req"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"headers"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'x-auth-role'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","keyword"]},"children":[{"type":"text","value":"const"}]},{"type":"text","value":" userId "},{"type":"element","tagName":"span","properties":{"className":["token","operator"]},"children":[{"type":"text","value":"="}]},{"type":"text","value":" req"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"."}]},{"type":"text","value":"headers"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"["}]},{"type":"element","tagName":"span","properties":{"className":["token","string"]},"children":[{"type":"text","value":"'x-auth-id'"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"]"}]},{"type":"text","value":"\n  "},{"type":"element","tagName":"span","properties":{"className":["token","comment"]},"children":[{"type":"text","value":"// Do something with `role` and `userId`"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":"}"}]},{"type":"element","tagName":"span","properties":{"className":["token","punctuation"]},"children":[{"type":"text","value":")"}]}]}]}]},{"type":"text","value":"\n"},{"type":"element","tagName":"h1","properties":{},"children":[{"type":"text","value":"마무리"}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Nginx Ingress Controller 를 이용하여 마이크로서비스 인증 로직을 하나의 서비스에서 처리하고, 다른 서비스에서는 인증 로직에 대해\n신경을 쓰지 않을 수 있도록 하는 구조에 대해 알아봤다. 이를 이용하면, "},{"type":"element","tagName":"strong","properties":{},"children":[{"type":"text","value":"서비스마다 관심사"}]},{"type":"text","value":"를 분리하는데 보다 도움이 될 수 있을 것이다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"실제 프로젝트를 진행하다보면, 특정 경로로 들어오는 경우에는 인증을 거치지 않아야 하는 것이 필요할 수 있다.\n이 때는 특정 경로에 대해서는 인증 로직을 수행하지 않도록 예외처리가 필요하다."}]},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"이 부분에 대해서는 다음 포스팅에서 알아보도록 하자."}]}],"data":{"quirksMode":false}},"excerpt":"nginx ingress controller…","timeToRead":4,"frontmatter":{"title":"Kubernetes Nginx Ingress Controller Auth(인증) 사용하기","userDate":"19 December 2020","date":"2020-12-19T00:00:00.000Z","tags":["kubernetes","nginx","nginx ingress controller","auth","microservice"],"excerpt":null,"image":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACGUlEQVQ4y61U20uTYRx+xf8gULzzqrswhUILQpBCQi8M7CIivOiiAxFeKJLYhXemiOfDhRVrhgZRCLZyinhA3VrD1dB5YEOm6OeYNr99h+n27el739z4Np2bhx88vKcfz/s87+FHvF4vJEmCKIpnhiAIkGUZHo8HhJJdVFBiQnegEQ6HzwUaPM/HEkZCm0TboBJCSIV2Lj7/WMKYRLXVkkRy6Fz8xicSalVFQrf0DR+Xf0THwQRqj7WsVTS9aUP+58cgbbkMt748gYmzH7GaVCG19XTiDTLf3UXO4EOQjmtI676By/3luNR3By+nmlNTqIQV1t8Wd0Bac1AxVs/GD4yvQRqysbDjxD1Djbp2Fb6An60pqRB6pF2kd99kKlf/urHGbyLv0yOMr1twf6QWpOs6pJB8SKikRpjWVYCqmXboHMO4PfQCTt86NvzbKDfUolRXjT8OF+TAwclnGGO55Qo7q1G3mdmtnG5ha6+MPSj+UAWb2wmXi/uvUlGSX8rzyUZkvC1G1vsS1WIBSGc+svVlqBvqRZNBD+viAqzzDgT2g9FbT/ps5rbsKPz6LPpsilTr46Y5LM/b8dNsguWXFbwQSEyY6GHrl75jYMXI+rbfDsyazYzMYrVBEPdTVHj4zZS4r7cnyPDxEsOeX1bP74zFIRj3r7URQ0hr2GnKF1VMVUXA5rS3TCvthRZYWrZph7KfB5SD4zj8AzAsyrdnwyj9AAAAAElFTkSuQmCC","aspectRatio":1,"src":"/static/77ff7d950e67d35e8538892f657bf864/d2c76/nginx-auth.png","srcSet":"/static/77ff7d950e67d35e8538892f657bf864/d2c76/nginx-auth.png 429w","sizes":"(max-width: 429px) 100vw, 429px"}}},"author":[{"id":"Woojin","bio":"This is another test author with a profile background image","avatar":{"children":[{"__typename":"ImageSharp","fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAWAQEBAQAAAAAAAAAAAAAAAAADAQL/2gAMAwEAAhADEAAAAdV5qKgwXH//xAAZEAEBAAMBAAAAAAAAAAAAAAABAgADEgT/2gAIAQEAAQUC27SoISuJy/OsRz0g5//EABcRAQADAAAAAAAAAAAAAAAAAAABAhH/2gAIAQMBAT8BxNH/xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/AYxb/8QAGxAAAgMAAwAAAAAAAAAAAAAAAREAAiEQMUH/2gAIAQEABj8CC9iBeaOFWCgZsMc6n//EABsQAQADAQADAAAAAAAAAAAAAAEAESExQVGB/9oACAEBAAE/IXs9PYxNZPCyYB6zWAFPviCw7C9VE7Y//9oADAMBAAIAAwAAABAY7//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAwEBPxDeJIt//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAgEBPxBAMbfb/8QAGxABAQACAwEAAAAAAAAAAAAAAREAMSFBUYH/2gAIAQEAAT8Qb0BngyYMN1g0Xzu5DRTRVwq5Wq4D5nJCmiAqB5rJ3rJYZ//Z","aspectRatio":1.3333333333333333,"src":"/static/e51acbf8a0e98b7912a2f1b775f15047/2f1b1/woojin.jpg","srcSet":"/static/e51acbf8a0e98b7912a2f1b775f15047/b3d27/woojin.jpg 40w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/5a735/woojin.jpg 80w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/6e81a/woojin.jpg 120w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/2f1b1/woojin.jpg 800w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/c4b07/woojin.jpg 1440w","sizes":"(max-width: 800px) 100vw, 800px"}}]}}]}},"relatedPosts":{"totalCount":3,"edges":[{"node":{"id":"7ab650db-1d53-54aa-9bad-5da6a93b94c4","timeToRead":2,"excerpt":"개요 지난 포스팅 에서 kubernetes 에서\nnginx ingress controller 를 활용하여 auth…","frontmatter":{"title":"Kubernetes Nginx Ingress Controller 선택적으로 Auth(인증) 하기","date":"2020-12-28T00:00:00.000Z"},"fields":{"slug":"/2020-12-28-nginx-ingress-controller-selective-auth/index/"}}},{"node":{"id":"ae287bd3-a4df-536d-a027-6c16a2d66333","timeToRead":4,"excerpt":"nginx ingress controller…","frontmatter":{"title":"Kubernetes Nginx Ingress Controller Auth(인증) 사용하기","date":"2020-12-19T00:00:00.000Z"},"fields":{"slug":"/2020-12-19-nginx-ingress-controller-auth/index/"}}},{"node":{"id":"2b474a47-b933-5312-8acc-1160fc9e9231","timeToRead":2,"excerpt":"개요 쿠버네티스 클러스터 외부의 트래픽을 정해진 라우팅 규칙을 통해 내부 서비스로 연결해주는 \n쿠버네티스 리소스를 인그레스(ingress) 라고 한다. 인그레스가 작동하려면 인그레스 컨트롤러가 반드시 필요한데 본 포스팅에서는 Nginx Ingress…","frontmatter":{"title":"Minikube 로 Nginx Ingress Controller 사용하기 (with AWS ECR)","date":"2020-12-17T00:00:00.000Z"},"fields":{"slug":"/2020-12-17-nginx-ingress-controller/index/"}}}]}},"pageContext":{"slug":"/2020-12-19-nginx-ingress-controller-auth/index/","prev":{"excerpt":"개요 나는 jetbrain 사의 intellij 계열의 IDE 를 주로 사용한다.\n유료이긴 하지만 리팩토링 툴이나 의존성을 체크해주는 등의 기능은 그 돈 값을 충분히 한다고 생각한다. bazel…","timeToRead":4,"frontmatter":{"title":"Intellij 에서 bazel plugin 사용하기","tags":["intellij","bazel"],"date":"2020-12-18T00:00:00.000Z","draft":false,"excerpt":null,"image":{"childImageSharp":{"fluid":{"aspectRatio":1,"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAADh0lEQVQ4y42U7W9TdRTHT9s7l0hIGEZg7dRXCJoRMOHJJZRtbW9vb1dWMjUEXhKTho3Rrvd2jHVMHoIaCYoaHyLK2NyUvQANvCHhBVlAxzOdwXeihjfqX0B2b3/Hc373oR1K9JecnJPz/Z7P77S3twB0ShWTE5gVM1CaM8A75pwRdHTD91AOenqpsp89AdfrNWuwmtE0CBxxYaG6fsjNy6lv1l28EFoPo/rk4T8OIQGv09BiCZgzQh6M9EVUXz38J3kqxqf+ZS4UCrcL9Zt9PPJrmWGPyr8Mo1kxbpTmzMW1IXMRAX8oPxgmj/lo5Dfp/dzTC7fzgdr3VTE+Yhhlm0JQzPMg5ZtvPzz69Im/3mukenbkgfTMux6LoZR9qDz7bu078tbDURYsullQ8AZycPT3g0g3z+Rv5a9wzT1PZy/P8Czp7/pAfSpzuf9OPw7d32+RwTOKwZ9KWLxXtLLf9WD2fA8W7w5Y3GPN9cgZntW/ycz4wPYv4xe06S7sne21hu4PonGv6MDuDojMdFaQXuXInM0K7rHGHvb2zfZZqekMkn7JB8bGkhfjUylMjKesPT/2igM/D+HAHR+GpAsOrrlHD1J6aAGhTqSs+KTGnhqw87R6OUkbdnyVmCeDyF3NVbef6xHRUzEJI10G19EvYpglLXctV1UndMEzyek0kj5Tv6FOjWp8XMPEGc1e88Fmse7DNqFN6NjhgjhoWGhTXfjKO+tF66G1IjGRsmPjSb6Uo9uBnVaD9VBtKo2rjq+3A/mw2PBJVKjjKQllmDqZxo3vt4lAPCBeHFxta9928WbYOaZ2O6xkEKJfqwxVnIeT0AlQbT25GaFvma0UWwi6RahnNFQnddx44lWhpBoEtIH98uga5AvaT8U9WIjA7nc4luSGhGbPZvXVxzdUodCM0L/CDhUiYtNnW8Um2iykKQLawYYOwFVDL2H39695MGUBzMsvHFsroU3llTrkw1UYCEtoQ6FFNGQaBUQJlgCEGOCSnU0S9lzv8z7sH9Ad51+HyJFWxXl9mnUKAcUIwp5lNqgBm0EyOkHCIrkWhR7MQpj/03Gh5et7YcnwSg+apk0F7F2BoAUZxEAJa9q1VMmc2/7vsNpLHa7lfNiBFlt06FuOkAohfeRtzk8DFIK7m8B/HB/aDPDmM86f6+6lPZBtfEPW254K/X/Y41A+uWf9v3xIK7X6CbC/ATWgHGQbicHiAAAAAElFTkSuQmCC","sizes":"(max-width: 1024px) 100vw, 1024px","src":"/static/d93dd1c5d2567c20ce1dee64f0996354/a8378/bazel.png","srcSet":"/static/d93dd1c5d2567c20ce1dee64f0996354/c5c6c/bazel.png 930w,\n/static/d93dd1c5d2567c20ce1dee64f0996354/a8378/bazel.png 1024w"}}},"author":[{"id":"Woojin","bio":"This is another test author with a profile background image","avatar":{"children":[{"fluid":{"aspectRatio":1.3333333333333333,"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAWAQEBAQAAAAAAAAAAAAAAAAADAQL/2gAMAwEAAhADEAAAAdV5qKgwXH//xAAZEAEBAAMBAAAAAAAAAAAAAAABAgADEgT/2gAIAQEAAQUC27SoISuJy/OsRz0g5//EABcRAQADAAAAAAAAAAAAAAAAAAABAhH/2gAIAQMBAT8BxNH/xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/AYxb/8QAGxAAAgMAAwAAAAAAAAAAAAAAAREAAiEQMUH/2gAIAQEABj8CC9iBeaOFWCgZsMc6n//EABsQAQADAQADAAAAAAAAAAAAAAEAESExQVGB/9oACAEBAAE/IXs9PYxNZPCyYB6zWAFPviCw7C9VE7Y//9oADAMBAAIAAwAAABAY7//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAwEBPxDeJIt//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAgEBPxBAMbfb/8QAGxABAQACAwEAAAAAAAAAAAAAAREAMSFBUYH/2gAIAQEAAT8Qb0BngyYMN1g0Xzu5DRTRVwq5Wq4D5nJCmiAqB5rJ3rJYZ//Z","sizes":"(max-width: 800px) 100vw, 800px","src":"/static/e51acbf8a0e98b7912a2f1b775f15047/2f1b1/woojin.jpg","srcSet":"/static/e51acbf8a0e98b7912a2f1b775f15047/fd013/woojin.jpg 200w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/25252/woojin.jpg 400w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/2f1b1/woojin.jpg 800w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/0ff54/woojin.jpg 1200w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/c4b07/woojin.jpg 1440w"}}]}}]},"fields":{"layout":"","slug":"/2020-12-18-intellij-bazel/index/"}},"next":{"excerpt":"개요 지난 포스팅 에서 kubernetes 에서\nnginx ingress controller 를 활용하여 auth…","timeToRead":2,"frontmatter":{"title":"Kubernetes Nginx Ingress Controller 선택적으로 Auth(인증) 하기","tags":["kubernetes","nginx","nginx ingress controller","auth","microservice"],"date":"2020-12-28T00:00:00.000Z","draft":false,"excerpt":null,"image":{"childImageSharp":{"fluid":{"aspectRatio":1,"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAACGUlEQVQ4y61U20uTYRx+xf8gULzzqrswhUILQpBCQi8M7CIivOiiAxFeKJLYhXemiOfDhRVrhgZRCLZyinhA3VrD1dB5YEOm6OeYNr99h+n27el739z4Np2bhx88vKcfz/s87+FHvF4vJEmCKIpnhiAIkGUZHo8HhJJdVFBiQnegEQ6HzwUaPM/HEkZCm0TboBJCSIV2Lj7/WMKYRLXVkkRy6Fz8xicSalVFQrf0DR+Xf0THwQRqj7WsVTS9aUP+58cgbbkMt748gYmzH7GaVCG19XTiDTLf3UXO4EOQjmtI676By/3luNR3By+nmlNTqIQV1t8Wd0Bac1AxVs/GD4yvQRqysbDjxD1Djbp2Fb6An60pqRB6pF2kd99kKlf/urHGbyLv0yOMr1twf6QWpOs6pJB8SKikRpjWVYCqmXboHMO4PfQCTt86NvzbKDfUolRXjT8OF+TAwclnGGO55Qo7q1G3mdmtnG5ha6+MPSj+UAWb2wmXi/uvUlGSX8rzyUZkvC1G1vsS1WIBSGc+svVlqBvqRZNBD+viAqzzDgT2g9FbT/ps5rbsKPz6LPpsilTr46Y5LM/b8dNsguWXFbwQSEyY6GHrl75jYMXI+rbfDsyazYzMYrVBEPdTVHj4zZS4r7cnyPDxEsOeX1bP74zFIRj3r7URQ0hr2GnKF1VMVUXA5rS3TCvthRZYWrZph7KfB5SD4zj8AzAsyrdnwyj9AAAAAElFTkSuQmCC","sizes":"(max-width: 429px) 100vw, 429px","src":"/static/77ff7d950e67d35e8538892f657bf864/d2c76/nginx-auth.png","srcSet":"/static/77ff7d950e67d35e8538892f657bf864/d2c76/nginx-auth.png 429w"}}},"author":[{"id":"Woojin","bio":"This is another test author with a profile background image","avatar":{"children":[{"fluid":{"aspectRatio":1.3333333333333333,"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAWAQEBAQAAAAAAAAAAAAAAAAADAQL/2gAMAwEAAhADEAAAAdV5qKgwXH//xAAZEAEBAAMBAAAAAAAAAAAAAAABAgADEgT/2gAIAQEAAQUC27SoISuJy/OsRz0g5//EABcRAQADAAAAAAAAAAAAAAAAAAABAhH/2gAIAQMBAT8BxNH/xAAXEQEAAwAAAAAAAAAAAAAAAAAAAREh/9oACAECAQE/AYxb/8QAGxAAAgMAAwAAAAAAAAAAAAAAAREAAiEQMUH/2gAIAQEABj8CC9iBeaOFWCgZsMc6n//EABsQAQADAQADAAAAAAAAAAAAAAEAESExQVGB/9oACAEBAAE/IXs9PYxNZPCyYB6zWAFPviCw7C9VE7Y//9oADAMBAAIAAwAAABAY7//EABYRAQEBAAAAAAAAAAAAAAAAAAEAEf/aAAgBAwEBPxDeJIt//8QAFxEBAQEBAAAAAAAAAAAAAAAAAQARUf/aAAgBAgEBPxBAMbfb/8QAGxABAQACAwEAAAAAAAAAAAAAAREAMSFBUYH/2gAIAQEAAT8Qb0BngyYMN1g0Xzu5DRTRVwq5Wq4D5nJCmiAqB5rJ3rJYZ//Z","sizes":"(max-width: 800px) 100vw, 800px","src":"/static/e51acbf8a0e98b7912a2f1b775f15047/2f1b1/woojin.jpg","srcSet":"/static/e51acbf8a0e98b7912a2f1b775f15047/fd013/woojin.jpg 200w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/25252/woojin.jpg 400w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/2f1b1/woojin.jpg 800w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/0ff54/woojin.jpg 1200w,\n/static/e51acbf8a0e98b7912a2f1b775f15047/c4b07/woojin.jpg 1440w"}}]}}]},"fields":{"layout":"","slug":"/2020-12-28-nginx-ingress-controller-selective-auth/index/"}},"primaryTag":"kubernetes"}},"staticQueryHashes":["1065875448","4129920265"]}